<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Museum Lichtenberg: Orte des Widerstands</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --text-main: #ffffff;
            --c-erinnerung: #D4AF37;
            --c-gedenken: #A0A0A0;
            --c-widerstand: #00E676;
            --c-heute: #FF3D00;
            --c-path: #00FFFF;

            --font-head: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
            
            --sidebar-width: 500px;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-body); overflow: hidden; }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* HEADER */
        header { 
            position: absolute; top: 30px; left: 30px; pointer-events: auto;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        .museum-label { 
            font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; 
            color: #aaa; margin-bottom: 5px; font-weight: 500; border-left: 3px solid var(--c-widerstand); padding-left: 10px;
        }
        h1 { 
            font-family: var(--font-head); font-size: 3rem; margin: 0; line-height: 0.9; font-weight: 700;
            color: white; letter-spacing: -1px;
        }

        /* --- 1. THE TRIGGER BUTTON (Visible on Map) --- */
        #btn-activate-scan {
            position: absolute; top: 160px; left: 30px; pointer-events: auto;
            background: rgba(0,0,0,0.8); color: var(--c-widerstand);
            border: 2px solid var(--c-widerstand); border-radius: 50px;
            padding: 12px 25px; cursor: pointer;
            font-family: var(--font-head); font-weight: bold; font-size: 1rem; letter-spacing: 1px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }
        #btn-activate-scan:hover { background: var(--c-widerstand); color: black; }
        #btn-activate-scan:active { transform: scale(0.95); }

        /* --- 2. THE MINI SCANNER WINDOW (Hidden by default) --- */
        #mini-scanner-wrapper {
            position: absolute; 
            top: 160px; left: 30px; 
            width: 240px; height: 180px;
            background: #000;
            border: 2px solid var(--c-widerstand);
            border-radius: 12px;
            overflow: hidden;
            z-index: 20; 
            pointer-events: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,1);
            display: none; /* Hidden until button clicked */
            flex-direction: column;
        }
        
        #reader { flex: 1; width: 100%; height: 100%; object-fit: cover; }

        /* Close Button for Scanner */
        #btn-close-scanner {
            position: absolute; top: 5px; right: 5px; width: 24px; height: 24px;
            background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%;
            cursor: pointer; z-index: 30; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        /* --- 3. THE "OPEN LINK" OVERLAY (Inside Scanner) --- */
        #scan-result-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; /* Hidden by default */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 25; text-align: center;
        }
        
        .result-btn {
            background: var(--c-widerstand); color: black; border: none;
            padding: 10px 15px; border-radius: 4px; font-weight: bold;
            font-family: var(--font-head); text-transform: uppercase; font-size: 0.9rem;
            cursor: pointer; margin-top: 5px; 
            box-shadow: 0 0 15px var(--c-widerstand);
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* UI Elements */
        #status-panel { position: absolute; top: 30px; right: 30px; width: 240px; pointer-events: auto; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .status-header { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--c-widerstand); width: 0%; transition: width 0.5s; box-shadow: 0 0 8px var(--c-widerstand); }
        .lock-text { text-align: right; font-family: var(--font-head); font-size: 0.9rem; color: #666; margin-top: 5px; }

        #legend { position: absolute; bottom: 30px; left: 30px; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #ccc; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        #timeline-ui { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 900px; min-width: 320px; pointer-events: auto; text-align: center; background: rgba(10, 10, 10, 0.85); padding: 15px 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #year-display { font-family: var(--font-head); font-size: 2.5rem; font-weight: 700; display: block; margin-bottom: 5px; line-height: 1; color: white; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #000; margin-top: -8px; transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); background: var(--c-path); }
        .ticks { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-size: 0.8rem; color: #ccc; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-head); }

        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #080808; border-left: 1px solid #333; z-index: 60; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.8); }
        #sidebar.open { transform: translateX(0); }
        .close-area { position: sticky; top: 0; width: 100%; height: 70px; z-index: 50; display: flex; justify-content: flex-end; align-items: center; padding-right: 25px; background: linear-gradient(to bottom, rgba(8,8,8,1) 50%, rgba(8,8,8,0)); }
        .close-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .close-btn:hover { background: white; color: black; }
        .sidebar-content { padding: 40px; padding-top: 0; }
        .hero-img { width: 100%; height: 300px; object-fit: cover; border-bottom: 4px solid #333; margin-bottom: 25px; }
        .cat-tag { font-family: var(--font-head); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: inline-block; padding: 4px 8px; border: 1px solid #444; color: #fff; }
        h2 { font-family: var(--font-head); font-size: 2.2rem; line-height: 1.1; margin: 0 0 25px 0; font-weight: 700; color: white; }
        .article { font-size: 1.05rem; line-height: 1.7; color: #ccc; font-weight: 300; margin-bottom: 40px; }
        .article h3 { color: white; font-family: var(--font-head); font-size: 1.2rem; margin-top: 30px; margin-bottom: 10px; font-weight: 500; border-left: 3px solid var(--c-path); padding-left: 10px; }
        .source { font-size: 0.75rem; color: #666; border-top: 1px solid #222; padding-top: 20px; font-style: italic; }
        
        .locked-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; color: #555; }
        .locked-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

        .vignette-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; background: radial-gradient(circle at center, transparent 35%, rgba(0,0,0,0.7) 60%, rgba(0,0,0,1) 90%); }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 100%; }
            #timeline-ui { width: 90%; bottom: 20px; padding: 15px 20px; }
            .sidebar-content { padding: 25px; }
            #mini-scanner-wrapper { top: 120px; left: 20px; }
            #btn-activate-scan { top: 120px; left: 20px; }
        }

        .mapboxgl-popup-content { background: #000; color: #fff; border: 1px solid #444; font-family: var(--font-body); padding: 10px 14px; }
        .mapboxgl-popup-close-button { display: none; }

    </style>
</head>
<body class="p-1933">

    <div id="map"></div>
    <div class="vignette-overlay"></div>

    <div id="ui-layer">
        <header>
            <div class="museum-label">Museum Lichtenberg</div>
            <h1>Orte des<br>Widerstands</h1>
        </header>

        <button id="btn-activate-scan" onclick="toggleScanner()">
            <span>ðŸ“·</span> SCAN QR
        </button>

        <div id="mini-scanner-wrapper">
            <button id="btn-close-scanner" onclick="toggleScanner()">Ã—</button>
            <div id="reader"></div>
            
            <div id="scan-result-layer">
                <div style="color:white; font-size:0.7rem; margin-bottom:8px; font-family:var(--font-head);">QR-CODE GEFUNDEN</div>
                <button id="scan-action-btn" class="result-btn">EVENT ANZEIGEN</button>
            </div>
        </div>

        <div id="status-panel">
            <div class="status-header">Archiv Fortschritt</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="lock-text" id="lock-status">GEGENWART GESPERRT</div>
        </div>

        <div id="legend">
            <div class="legend-item"><div class="dot" style="background:var(--c-erinnerung)"></div> Orte der Erinnerung</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-gedenken)"></div> Gedenken</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-widerstand)"></div> Orte des Widerstands</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-heute)"></div> Gegen Rechts Heute</div>
        </div>

        <div id="timeline-ui">
            <span id="year-display">1933</span>
            <input type="range" id="year-slider" min="1933" max="2026" value="1933" step="1">
            <div class="ticks">
                <span>1933</span><span>1990</span><span>2000</span><span>Heute</span>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="close-area">
            <button class="close-btn" onclick="closeSidebar()">&times;</button>
        </div>
        <div id="sidebar-content"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // 1. CONFIG
        // ------------------------------------------------------------------
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWxpYXNtZXJhYmloYSIsImEiOiJjbWw5bHNnc3YwM3ZwM2RxdXU5YjdiN201In0.CTiUlh-M4fTkIda8EtP4Yg'; 

        const geoData = {
            'type': 'FeatureCollection',
            'features': [
                // (INSERT YOUR FULL FEATURE LIST HERE AS BEFORE)
                // Keeping it short here for brevity, assume the 12 features are here.
                { 'type': 'Feature', 'properties': { 'id': 'h1', 'category': 'erinnerung', 'title': 'Der Blutbaum', 'year': 1934, 'image': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Gedenkstein_Loeperplatz_%28Berlin-Lichtenberg%29.jpg/800px-Gedenkstein_Loeperplatz_%28Berlin-Lichtenberg%29.jpg', 'description': '...', 'source': '...' }, 'geometry': { 'type': 'Point', 'coordinates': [13.4800, 52.5135] } },
                { 'type': 'Feature', 'properties': { 'id': 'g1', 'category': 'gedenken', 'title': 'Silvio Meier', 'year': 1992, 'image': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Gedenktafel_Silvio_Meier_%28U-Bhf_Samariterstra%C3%9Fe%29.jpg/800px-Gedenktafel_Silvio_Meier_%28U-Bhf_Samariterstra%C3%9Fe%29.jpg', 'description': '...', 'source': '...' }, 'geometry': { 'type': 'Point', 'coordinates': [13.4650, 52.5140] } }
            ]
        };

        let state = {
            discovered: [],
            required: 3,
            unlocked: false,
            scannerActive: false,
            html5QrCode: null
        };

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [13.485, 52.51],
            zoom: 12.5,
            pitch: 45,
            bearing: -10
        });

        // ------------------------------------------------------------------
        // 2. SCANNER LOGIC
        // ------------------------------------------------------------------
        function toggleScanner() {
            const wrapper = document.getElementById('mini-scanner-wrapper');
            const btn = document.getElementById('btn-activate-scan');
            
            if (state.scannerActive) {
                // STOP SCANNER
                if(state.html5QrCode) {
                    state.html5QrCode.stop().then(() => {
                        state.html5QrCode.clear();
                        wrapper.style.display = 'none';
                        btn.style.display = 'flex';
                        state.scannerActive = false;
                    });
                }
            } else {
                // START SCANNER
                wrapper.style.display = 'flex';
                btn.style.display = 'none';
                state.scannerActive = true;
                
                // Hide result layer if visible from prev scan
                document.getElementById('scan-result-layer').style.display = 'none';

                if(!state.html5QrCode) state.html5QrCode = new Html5Qrcode("reader");
                
                state.html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: 150 },
                    onScanSuccess
                ).catch(err => {
                    console.log("Error starting camera", err);
                    alert("Kamera konnte nicht gestartet werden. Bitte Berechtigungen prÃ¼fen.");
                    toggleScanner(); // revert UI
                });
            }
        }

        function onScanSuccess(decodedText) {
            // 1. Pause Camera
            state.html5QrCode.pause();

            // 2. Parse ID
            let eventId = null;
            try {
                const url = new URL(decodedText);
                eventId = url.searchParams.get("event");
            } catch (e) {
                eventId = decodedText;
            }

            // 3. Check Database
            const target = geoData.features.find(f => f.properties.id === eventId);
            
            if (target) {
                // 4. Show "Open Link" Button
                const overlay = document.getElementById('scan-result-layer');
                const btn = document.getElementById('scan-action-btn');
                overlay.style.display = 'flex';
                
                btn.onclick = () => {
                    // ACTION!
                    toggleScanner(); // Close the scanner window
                    
                    // Game Logic
                    if (!state.discovered.includes(eventId)) {
                        state.discovered.push(eventId);
                        updateProgress();
                    }
                    if (target.properties.locked) unlockAll();
                    else updateMap(target.properties.year);
                    
                    // Fly to Marker
                    handleMarker(target.properties, target.geometry.coordinates, true);
                };
            } else {
                // Unknown code? Resume after 2s
                alert("Unbekannter QR Code: " + eventId);
                setTimeout(() => state.html5QrCode.resume(), 1000);
            }
        }

        // ------------------------------------------------------------------
        // 3. MAP LOGIC
        // ------------------------------------------------------------------
        map.on('load', () => {
            // (Standard Mapbox Layers - condensed for brevity)
            map.addLayer({ 'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'type': 'fill-extrusion', 'paint': { 'fill-extrusion-color': '#222', 'fill-extrusion-height': ['get', 'height'] } }, 'waterway-label');
            
            map.addSource('markers', { 'type': 'geojson', 'data': geoData });
            map.addLayer({ 'id': 'marker-glow', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 40, 'circle-color': ['match', ['get', 'category'], 'erinnerung', '#D4AF37', 'gedenken', '#A0A0A0', 'widerstand', '#00E676', 'heute', '#FF3D00', '#fff'], 'circle-opacity': 0.3 } });
            map.addLayer({ 'id': 'marker-core', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 10, 'circle-color': '#fff' } });

            map.on('click', 'marker-core', (e) => handleMarker(e.features[0].properties, e.features[0].geometry.coordinates));
            
            // Handle URL Deep Link (if user scans with native cam app)
            const urlParams = new URLSearchParams(window.location.search);
            const startEvent = urlParams.get('event');
            if(startEvent) {
                const t = geoData.features.find(f => f.properties.id === startEvent);
                if(t) handleMarker(t.properties, t.geometry.coordinates, true);
            }
            
            updateMap(1933);
        });

        // (Helper Functions: handleMarker, updateMap, updateProgress, unlockAll, openSidebar...)
        // COPY THESE from the previous turn, they remain exactly the same.
        function handleMarker(props, coords, force = false) {
            if (props.locked && !state.unlocked && !force) { openSidebarLocked(); return; }
            if (!state.discovered.includes(props.id) && !props.locked) { state.discovered.push(props.id); updateProgress(); }
            map.flyTo({ center: coords, zoom: 16, pitch: 60, offset: [0, -200], speed: 0.8 });
            openSidebar(props);
        }
        function updateProgress() {
            const pct = Math.min((state.discovered.length / state.required) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            if (state.discovered.length >= state.required && !state.unlocked) setTimeout(unlockAll, 1000);
        }
        function unlockAll() {
            state.unlocked = true;
            document.getElementById('lock-status').innerText = "FREIGESCHALTET";
            document.getElementById('lock-status').style.color = "#00E676";
            document.getElementById('progress-bar').style.background = "#00E676";
            document.getElementById('year-slider').value = 2026;
            updateMap(2026);
        }
        const slider = document.getElementById('year-slider');
        slider.addEventListener('input', (e) => {
            document.getElementById('year-display').innerText = e.target.value;
            updateMap(parseInt(e.target.value));
        });
        function updateMap(year) {
            const filter = ['<=', ['get', 'year'], year];
            map.setFilter('marker-glow', filter);
            map.setFilter('marker-core', filter);
        }
        function openSidebar(data) {
            const content = document.getElementById('sidebar-content');
            const colors = { 'erinnerung': '#D4AF37', 'gedenken': '#A0A0A0', 'widerstand': '#00E676', 'heute': '#FF3D00' };
            content.innerHTML = `<img src="${data.image}" class="hero-img"><div class="sidebar-content"><span class="cat-tag" style="border-color:${colors[data.category]}; color:${colors[data.category]}">${data.category.toUpperCase()}</span><h2>${data.title}</h2><div class="article">${data.description}</div><div class="source">Quelle: ${data.source}</div></div>`;
            document.getElementById('sidebar').classList.add('open');
        }
        function openSidebarLocked() {
            document.getElementById('sidebar-content').innerHTML = `<div class="locked-view"><div class="locked-icon">ðŸ”’</div><h2>GESPERRT</h2></div>`;
            document.getElementById('sidebar').classList.add('open');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            map.easeTo({ offset: [0, 0] });
        }
    </script>
</body>
</html>
