<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Museum Lichtenberg: Orte des Widerstands</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505; --text-main: #ffffff;
            --c-erinnerung: #D4AF37; --c-gedenken: #A0A0A0;
            --c-widerstand: #00E676; --c-heute: #FF3D00; --c-path: #00FFFF;
            --font-head: 'Space Grotesk', sans-serif; --font-body: 'Inter', sans-serif;
            --sidebar-width: 500px;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-body); overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* DEBUG CONSOLE (Remove later) */
        #debug-console {
            position: absolute; bottom: 10px; right: 10px; width: 250px; height: 100px;
            background: rgba(50,0,0,0.8); border: 1px solid red; color: white;
            font-size: 10px; font-family: monospace; padding: 5px; overflow-y: auto;
            z-index: 9999; pointer-events: none; display: block;
        }

        /* --- 1. SCANNER WINDOW (Top Left) --- */
        #scanner-container {
            position: absolute; top: 160px; left: 30px;
            width: 200px; height: 150px;
            background: #000; border: 2px solid var(--c-widerstand); border-radius: 8px;
            z-index: 50; overflow: hidden;
            display: none; /* Hidden initially */
            box-shadow: 0 10px 40px rgba(0,0,0,1);
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        #btn-close-scan {
            position: absolute; top: 5px; right: 5px; width: 24px; height: 24px;
            background: red; color: white; border: none; border-radius: 50%;
            cursor: pointer; z-index: 60; font-weight: bold;
        }

        /* --- 2. LINK BUTTON OVERLAY --- */
        #scan-success-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55;
        }
        .success-btn {
            background: var(--c-widerstand); color: black; border: none;
            padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer;
            margin-top: 5px; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- 3. TRIGGER BUTTON --- */
        #btn-start-scan {
            position: absolute; top: 160px; left: 30px; z-index: 40;
            background: rgba(0,0,0,0.8); color: var(--c-widerstand);
            border: 2px solid var(--c-widerstand); border-radius: 50px;
            padding: 12px 25px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 10px;
        }

        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .vignette-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; background: radial-gradient(circle at center, transparent 35%, rgba(0,0,0,0.7) 60%, rgba(0,0,0,1) 90%); }
        
        /* Header */
        header { position: absolute; top: 30px; left: 30px; pointer-events: auto; }
        .museum-label { font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: #aaa; margin-bottom: 5px; font-weight: 500; border-left: 3px solid var(--c-widerstand); padding-left: 10px; }
        h1 { font-family: var(--font-head); font-size: 3rem; margin: 0; line-height: 0.9; font-weight: 700; color: white; letter-spacing: -1px; }

        /* Timeline & Other UI */
        #timeline-ui { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 900px; min-width: 320px; pointer-events: auto; text-align: center; background: rgba(10, 10, 10, 0.85); padding: 15px 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px); }
        #year-display { font-family: var(--font-head); font-size: 2.5rem; font-weight: 700; display: block; margin-bottom: 5px; color: white; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #000; margin-top: -8px; }
        
        /* Sidebar */
        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #080808; border-left: 1px solid #333; z-index: 60; transform: translateX(100%); transition: transform 0.4s; overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column; }
        #sidebar.open { transform: translateX(0); }
        .close-area { position: sticky; top: 0; width: 100%; height: 70px; z-index: 50; display: flex; justify-content: flex-end; align-items: center; padding-right: 25px; background: linear-gradient(to bottom, rgba(8,8,8,1) 50%, rgba(8,8,8,0)); }
        .close-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sidebar-content { padding: 40px; padding-top: 0; }
        .hero-img { width: 100%; height: 300px; object-fit: cover; border-bottom: 4px solid #333; margin-bottom: 25px; }
        h2 { font-family: var(--font-head); font-size: 2.2rem; line-height: 1.1; margin: 0 0 25px 0; font-weight: 700; color: white; }
        .cat-tag { font-family: var(--font-head); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: inline-block; padding: 4px 8px; border: 1px solid #444; color: #fff; }
        .article { font-size: 1.05rem; line-height: 1.7; color: #ccc; font-weight: 300; margin-bottom: 40px; }
        .locked-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; color: #555; }
        .locked-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 100%; }
            #timeline-ui { width: 90%; bottom: 20px; padding: 15px 20px; }
            #scanner-container, #btn-start-scan { top: 120px; left: 20px; }
        }
    </style>
</head>
<body class="p-1933">

    <div id="debug-console">System Log...</div>

    <div id="map"></div>
    <div class="vignette-overlay"></div>

    <div id="ui-layer">
        <header>
            <div class="museum-label">Museum Lichtenberg</div>
            <h1>Orte des<br>Widerstands</h1>
        </header>

        <button id="btn-start-scan" onclick="activateScanner()">
            <span>ðŸ“·</span> SCAN QR
        </button>

        <div id="scanner-container">
            <button id="btn-close-scan" onclick="deactivateScanner()">Ã—</button>
            <div id="reader"></div>
            
            <div id="scan-success-overlay">
                <div style="color:white; font-size:0.8rem;">QR GEFUNDEN</div>
                <button id="btn-go-link" class="success-btn">Ã–FFNEN</button>
            </div>
        </div>

        <div id="timeline-ui">
            <span id="year-display">1933</span>
            <input type="range" id="year-slider" min="1933" max="2026" value="1933" step="1">
        </div>
    </div>

    <div id="sidebar">
        <div class="close-area"><button class="close-btn" onclick="closeSidebar()">&times;</button></div>
        <div id="sidebar-content"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // CONFIG
        // ------------------------------------------------------------------
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWxpYXNtZXJhYmloYSIsImEiOiJjbWw5bHNnc3YwM3ZwM2RxdXU5YjdiN201In0.CTiUlh-M4fTkIda8EtP4Yg'; 

        function debug(msg) {
            const el = document.getElementById('debug-console');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `[${time}] ${msg}<br>` + el.innerHTML;
            console.log(msg);
        }

        const geoData = {
            'type': 'FeatureCollection',
            'features': [
                // DATA
                { 'type': 'Feature', 'properties': { 'id': 'h1', 'category': 'erinnerung', 'title': 'Blutbaum', 'year': 1934, 'image': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Gedenkstein_Loeperplatz_%28Berlin-Lichtenberg%29.jpg/800px-Gedenkstein_Loeperplatz_%28Berlin-Lichtenberg%29.jpg', 'description': '...', 'source': '...' }, 'geometry': { 'type': 'Point', 'coordinates': [13.4800, 52.5135] } },
                { 'type': 'Feature', 'properties': { 'id': 'g1', 'category': 'gedenken', 'title': 'Silvio Meier', 'year': 1992, 'image': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Gedenktafel_Silvio_Meier_%28U-Bhf_Samariterstra%C3%9Fe%29.jpg/800px-Gedenktafel_Silvio_Meier_%28U-Bhf_Samariterstra%C3%9Fe%29.jpg', 'description': '...', 'source': '...' }, 'geometry': { 'type': 'Point', 'coordinates': [13.4650, 52.5140] } }
            ]
        };

        let state = { scanner: null, discovered: [] };

        const map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/dark-v11',
            center: [13.485, 52.51], zoom: 12.5, pitch: 45
        });

        // ------------------------------------------------------------------
        // SCANNER LOGIC (ROBUST)
        // ------------------------------------------------------------------
        function activateScanner() {
            debug("Aktiviere Scanner...");
            const btn = document.getElementById('btn-start-scan');
            const win = document.getElementById('scanner-container');
            const overlay = document.getElementById('scan-success-overlay');

            btn.style.display = 'none';
            win.style.display = 'block';
            overlay.style.display = 'none';

            // Wait 100ms for DIV to render before starting camera
            setTimeout(() => {
                if(!state.scanner) {
                    debug("Initialisiere Html5Qrcode...");
                    state.scanner = new Html5Qrcode("reader");
                }

                state.scanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 150 },
                    (decodedText) => {
                        // SUCCESS
                        debug("Scan Erfolg: " + decodedText);
                        handleScanResult(decodedText);
                    },
                    (errorMessage) => {
                        // Parsing error, ignore
                    }
                ).catch(err => {
                    debug("FATAL KAMERA FEHLER: " + err);
                    alert("Kamera Error: " + err);
                    deactivateScanner();
                });
            }, 100);
        }

        function deactivateScanner() {
            debug("Deaktiviere Scanner...");
            if(state.scanner) {
                state.scanner.stop().then(() => {
                    state.scanner.clear();
                    document.getElementById('scanner-container').style.display = 'none';
                    document.getElementById('btn-start-scan').style.display = 'flex';
                }).catch(err => debug("Stop Error: " + err));
            } else {
                document.getElementById('scanner-container').style.display = 'none';
                document.getElementById('btn-start-scan').style.display = 'flex';
            }
        }

        function handleScanResult(text) {
            // Pause
            state.scanner.pause();
            
            // Check Database
            let targetId = null;
            // Robust check: does the string contain any valid ID?
            for(let feat of geoData.features) {
                if(text.includes(feat.properties.id)) {
                    targetId = feat.properties.id;
                    break;
                }
            }

            if(targetId) {
                debug("ID erkannt: " + targetId);
                const feature = geoData.features.find(f => f.properties.id === targetId);
                
                // Show Button
                const overlay = document.getElementById('scan-success-overlay');
                const btn = document.getElementById('btn-go-link');
                
                overlay.style.display = 'flex';
                
                btn.onclick = () => {
                    debug("Ã–ffne Event...");
                    deactivateScanner();
                    
                    // Logic
                    handleMarker(feature.properties, feature.geometry.coordinates, true);
                };
            } else {
                debug("Unbekannte ID im Text.");
                // Resume after 2s
                setTimeout(() => state.scanner.resume(), 2000);
            }
        }

        // ------------------------------------------------------------------
        // MAP LOGIC
        // ------------------------------------------------------------------
        map.on('load', () => {
            map.addSource('markers', { 'type': 'geojson', 'data': geoData });
            map.addLayer({ 'id': 'marker-core', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 10, 'circle-color': '#fff' } });
            map.on('click', 'marker-core', (e) => handleMarker(e.features[0].properties, e.features[0].geometry.coordinates));
            
            // Deep Link
            const urlParams = new URLSearchParams(window.location.search);
            const evt = urlParams.get('event');
            if(evt) {
                debug("URL Parameter gefunden: " + evt);
                const t = geoData.features.find(f => f.properties.id === evt);
                if(t) handleMarker(t.properties, t.geometry.coordinates);
            }
        });

        function handleMarker(props, coords) {
            map.flyTo({ center: coords, zoom: 16 });
            openSidebar(props);
        }

        function openSidebar(data) {
            const content = document.getElementById('sidebar-content');
            content.innerHTML = `<img src="${data.image}" class="hero-img"><div class="sidebar-content"><h2>${data.title}</h2><div class="article">${data.description}</div></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
        }
    </script>
</body>
</html>
