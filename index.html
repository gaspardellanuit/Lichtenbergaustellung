<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00E676">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/gaspardellanuit/Lichtenbergaustellung/refs/heads/main/Bunter_Wind_LOGO-1.jpg">
    
    <title>Museum Lichtenberg: Orte des Widerstands</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Colors */
            --bg-color: #050505; --text-main: #ffffff;
            
            /* Kategorie 1: Erinnerung (Opfer) -> Neon Grün */
            --c-erinnerung: #00E676;   
            
            /* Kategorie 2: Widerstand (Aktuell) -> Neon Pink */
            --c-widerstand: #FF00FF;   
            
            /* Kategorie 3: Gedenken (Historisch) -> Neon Blue */
            --c-gedenken: #00BFFF;     

            --c-path: #00FFFF;         /* Cyan Path */

            /* Fonts */
            --font-head: 'Space Grotesk', sans-serif; --font-body: 'Inter', sans-serif;
            --sidebar-width: 500px;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-body); overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .start-btn {
            background: #00E676; /* Start Button Green */
            color: black; border: none;
            padding: 15px 50px; border-radius: 30px;
            font-family: var(--font-head); font-weight: bold; font-size: 1.2rem;
            cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 30px #00E676;
            transition: transform 0.2s;
        }
        .start-btn:active { transform: scale(0.95); }

        /* --- MINI SCANNER --- */
        #mini-scanner {
            position: absolute; 
            top: 260px; 
            left: 30px; 
            width: 120px; height: 120px; 
            background: #000;
            border: 2px solid #444;
            border-radius: 12px;
            overflow: hidden;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transition: border-color 0.3s;
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        .scanner-label {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: #aaa;
            font-size: 9px; text-align: center; padding: 3px;
            font-family: var(--font-head); letter-spacing: 1px;
            pointer-events: none;
        }

        /* Overlay bei Treffer */
        #scan-hit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 230, 118, 0.95); /* Green */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .hit-icon { font-size: 24px; color: black; font-weight: bold; }
        .hit-text { font-size: 10px; color: black; font-family: var(--font-head); font-weight: bold; margin-top: 2px; }

        /* UI LAYER */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .vignette-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.8) 60%, rgba(0,0,0,1) 90%); }
        
        header { position: absolute; top: 30px; left: 30px; pointer-events: auto; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .museum-label { font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; color: #aaa; margin-bottom: 5px; font-weight: 500; border-left: 3px solid var(--c-widerstand); padding-left: 10px; }
        h1 { font-family: var(--font-head); font-size: 3rem; margin: 0; line-height: 0.9; font-weight: 700; color: white; letter-spacing: -1px; }

        #timeline-ui { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 900px; min-width: 320px; pointer-events: auto; text-align: center; background: rgba(10, 10, 10, 0.85); padding: 15px 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #year-display { font-family: var(--font-head); font-size: 2.5rem; font-weight: 700; display: block; margin-bottom: 5px; line-height: 1; color: white; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #000; margin-top: -8px; transition: transform 0.1s; }
        .ticks { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-size: 0.8rem; color: #ccc; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-head); }
        .ticks span { text-align: center; flex: 1; }
        .ticks span:first-child { text-align: left; }
        .ticks span:last-child { text-align: right; }

        #status-panel { position: absolute; top: 30px; right: 30px; width: 240px; pointer-events: auto; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .status-header { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--c-widerstand); width: 0%; transition: width 0.5s; box-shadow: 0 0 8px var(--c-widerstand); }
        .lock-text { text-align: right; font-family: var(--font-head); font-size: 0.9rem; color: #666; margin-top: 5px; }

        #legend { position: absolute; bottom: 30px; left: 30px; pointer-events: auto; display: flex; flex-direction: column; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #ccc; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* HOME BUTTON */
        #home-btn {
            position: absolute; bottom: 30px; right: 30px;
            width: 50px; height: 50px;
            background: #222; border: 2px solid #444; border-radius: 50%;
            color: white; font-size: 24px;
            cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: all 0.2s; pointer-events: auto;
        }
        #home-btn:hover { background: #00E676; color: black; border-color: #00E676; }

        #sidebar { position: absolute; right: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #080808; border-left: 1px solid #333; z-index: 60; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.8); }
        #sidebar.open { transform: translateX(0); }
        .close-area { position: sticky; top: 0; width: 100%; height: 70px; z-index: 50; display: flex; justify-content: flex-end; align-items: center; padding-right: 25px; background: linear-gradient(to bottom, rgba(8,8,8,1) 50%, rgba(8,8,8,0)); }
        .close-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .close-btn:hover { background: white; color: black; }
        
        .sidebar-content { padding: 40px; padding-top: 0; }
        
        .hero-img { width: 100%; height: auto; max-height: 400px; object-fit: contain; border-bottom: 4px solid #333; margin-bottom: 25px; background: #000; display: block; margin-left: auto; margin-right: auto; }
        .cat-tag { font-family: var(--font-head); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: inline-block; padding: 4px 8px; border: 1px solid #444; color: #fff; }
        h2 { font-family: var(--font-head); font-size: 2.2rem; line-height: 1.1; margin: 0 0 25px 0; font-weight: 700; color: white; }
        
        .article { font-size: 1.05rem; line-height: 1.7; color: #ffffff; font-weight: 300; margin-bottom: 40px; }
        .article h3 { color: #ffffff; font-family: var(--font-head); font-size: 1.2rem; margin-top: 30px; margin-bottom: 10px; font-weight: 500; border-left: 3px solid var(--c-path); padding-left: 10px; }
        .article h4 { color: #ffffff; font-family: var(--font-head); font-size: 1.0rem; margin-top: 25px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .article p { margin-bottom: 15px; }
        .article ul { padding-left: 20px; margin-bottom: 20px; }
        .article li { margin-bottom: 8px; }
        .source { font-size: 0.75rem; color: #666; border-top: 1px solid #222; padding-top: 20px; font-style: italic; }
        .locked-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; color: #555; }
        .locked-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 100%; }
            #timeline-ui { width: 90%; bottom: 20px; padding: 15px 20px; }
            .sidebar-content { padding: 25px; }
            #mini-scanner { top: 120px; left: 20px; } 
        }
        .mapboxgl-popup-content { background: #000; color: #fff; border: 1px solid #444; font-family: var(--font-body); padding: 10px 14px; }
        .mapboxgl-popup-close-button { display: none; }
    </style>
</head>
<body class="p-1933">

    <div id="start-screen">
        <h1 style="color:white; margin-bottom: 10px; text-shadow:0 0 20px black;">Museum Lichtenberg</h1>
        <p style="color:#aaa; font-family:var(--font-head);">Orte des Widerstands</p>
        <button class="start-btn" onclick="startExhibition()">Ausstellung Starten</button>
    </div>

    <div id="map"></div>
    <div class="vignette-overlay"></div>

    <div id="ui-layer">
        <header>
            <div class="museum-label">Museum Lichtenberg</div>
            <h1>Orte des<br>Widerstands</h1>
        </header>

        <div id="mini-scanner">
            <div id="reader"></div>
            <div class="scanner-label">SCAN QR</div>
            
            <div id="scan-hit-overlay" onclick="executeScanAction()">
                <div class="hit-icon">➜</div>
                <div class="hit-text">ÖFFNEN</div>
            </div>
        </div>

        <div id="status-panel">
            <div class="status-header">Archiv Fortschritt</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="lock-text" id="lock-status">GEGENWART GESPERRT</div>
        </div>

        <div id="legend">
            <div class="legend-item"><div class="dot" style="background:var(--c-erinnerung)"></div> Orte der Erinnerung</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-gedenken)"></div> Gedenken</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-widerstand)"></div> Widerstand</div>
        </div>

        <div id="timeline-ui">
            <span id="year-display">1933</span>
            <input type="range" id="year-slider" min="1933" max="2026" value="1933" step="1">
            <div class="ticks">
                <span>1933</span><span>1990</span><span>2000</span><span>Heute</span>
            </div>
        </div>

        <button id="home-btn" onclick="location.reload()" title="Zurück zum Start">
            ⌂
        </button>
    </div>

    <div id="sidebar">
        <div class="close-area"><button class="close-btn" onclick="closeSidebar()">&times;</button></div>
        <div id="sidebar-content"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // CONFIG
        // ------------------------------------------------------------------
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWxpYXNtZXJhYmloYSIsImEiOiJjbWxneDV4dGgwMWl1M2VzYTBzMHJ0NGZ5In0.MwZMTp_9rIxJfO5kafmr6g'; 

        const geoData = {
            'type': 'FeatureCollection',
            'features': [
                // === KATEGORIE 1: ORTE DER ERINNERUNG (Opfer & Widerstandskämpfer:innen) ===
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'kurt_schneider',
                        'category': 'erinnerung',
                        'title': 'Kurt Schneider (*1961 – †1999)',
                        'year': 1999,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/01/Memorial_plaque_metal_Kurt_Schneider_Berlin%2C_Germany.jpg',
                        'description': `
                            <h4>Hintergrund</h4>
                            <p>Kurt Schneider wurde 1961 in Königs Wusterhausen geboren. Er arbeitete als Maurer und lebte ab 1999 im Bezirk Lichtenberg.</p>
                            
                            <h4>Der Mord</h4>
                            <p>In der Nacht auf den 6. Oktober 1999 wurde er nachts auf dem Heimweg von einer Tankstelle von vier Neonazis überfallen und zusammengeschlagen. Die vier Täter ließen Schneider zurück, kehrten jedoch einige Zeit später mit einem Messer bewaffnet an den Tatort zurück, traten erneut auf ihn ein und ermordeten ihn daraufhin mit vier Messerstichen. Den Leichnam Kurt Schneiders ließen sie in einem Gebüsch zurück.</p>
                            
                            <h4>Juristische Aufarbeitung</h4>
                            <p>Bereits am nächsten Tag wurden die Täter verhaftet und Ende des Monats wegen schweren Raubes in Tateinheit mit gefährlicher Körperverletzung und Mord zu lebenslanger respektive langjähriger Haft verurteilt. Vor Gericht gaben sie zu, Schneider als Reaktion auf einen Gruß seinerseits angegriffen zu haben. Da sie ihn als minderwertigen Menschen ansahen, empfanden sie diese Geste als Beleidigung.</p>
                            <p>Das Gericht erkannte aber kein politisches Motiv. Die offen ausgedrückte rechtsradikale Gesinnung der Täter und ihr sozialdarwinistisches Weltbild wurden von den Behörden nicht beachtet. Stattdessen wurde die Tötung Schneiders als Vertuschungsversuch des vorangegangenen Raubüberfalls gedeutet. Erst 2018 wurde die Tat durch eine Studie der Technischen Universität Berlins nachträglich als rechtsextremer Gewaltakt und Kurt Schneider offiziell als Opfer rechter Gewalt anerkannt.</p>
                            
                            <h4>Gedenken</h4>
                            <p>Zur Enthüllung der Edelstahltafel am 17.8.2021 sprachen Bezirksbürgermeister Michael Grunst, der Vorsitzende der Lichtenberger Gedenktafelkommission Manfred Becker und Sebastian Sommer von der Antifaschistischen Vernetzung Lichtenberg. Die Tafel ist an einem steinernen Pfosten links neben der Treppe zum ehemaligen Friedhof befestigt. Ihrer Anbringung gingen Initiativen zivilgesellschaftlicher Gruppierungen voraus, die im Jahr 2019 anlässlich des 20. Todestages von Kurt Schneider erstmals öffentlich seiner gedachten.</p>
                        `,
                        'source': 'Gedenktafeln in Berlin - Kurt Schneider'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4802, 52.5185] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'silvio_meier',
                        'category': 'erinnerung',
                        'title': 'Silvio Meier (*1965 – †1992)',
                        'year': 1992,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/1/14/Silvio_Meier.jpg',
                        'description': `
                            <h4>Aktivismus in der DDR</h4>
                            <p>Silvio Meier wurde 1965 in Quedlinburg in Sachsen-Anhalt geboren. Im Jahr 1986 zog er in den Ostteil des damals geteilten Berlins. Hier wurde Silvio Meier politisch aktiv, engagierte sich in den oppositionellen Kreisen der DDR und beteiligte sich am Aufbau von Strukturen gegen das Regime. Er war unter anderem Mitbegründer der „Kirche von Unten“ sowie der Umweltbibliothek in der Zionskirche in Berlin-Mitte – einem der bedeutendsten Treffpunkte der späten DDR-Oppositionsbewegung. Silvio Meier war vom Beginn seines politischen Engagements an dazu gezwungen, sich mit rechter Gewalt auseinanderzusetzen. In der Zionskirche organisierte er am Abend des 18. Oktober 1987 ein Konzert, das von Neonazis überfallen wurde. Der Überfall auf die Zionskirche gilt als Wendepunkt in der Wahrnehmung der rechtsextremen Strömungen in der DDR, die bis dahin von der Führung weitestgehend ignoriert worden waren.</p>
                            
                            <h4>Hausbesetzung und Ermordung</h4>
                            <p>Nach dem Zusammenbruch der DDR wurde Silvio Meier Teil der Berliner Hausbesetzerszene. Er lebte in einem Haus in der Schreinerstraße 47 in Berlin-Friedrichshain und arbeitete in einer alternativen Druckerei. Silvio Meier wurde wegen seines antifaschistischen Auftretens ermordet und weil er erkennbar der alternativen Hausbesetzerszene angehörte – einem Feindbild der extremen Rechten.</p>
                            
                            <h4>Juristisches Nachspiel</h4>
                            <p>Obwohl die Angeklagten selbst keinen Hehl aus ihrer rechten Gesinnung machten, wurde den politischen Aspekten der Tat vor Gericht wenig Beachtung geschenkt. Die Hooliganszene der Täter wurde im Urteil als „Alkoholmissbrauch treibende Jugendgruppe“ bezeichnet und damit entpolitisiert.</p>
                            
                            <h4>Erinnerungskultur</h4>
                            <p>In Gedenken an Silvio Meier wurde eine breite Erinnerungskultur etabliert, Angehörige und Engagierte halten das Andenken an ihn wach und setzen sich in seinem Namen gegen Rechtsextremismus und Menschenfeindlichkeit ein. Bereits einen Tag nach seiner Ermordung nahmen mehrere Tausend Menschen an einem Trauermarsch teil. Es erschienen etliche Zeitungsbeiträge über Silvio Meier, über den Mord und die Folgen der Tat. Es hieß, der Mord habe den Friedrichshainer Kiez „erschüttert“.</p>
                            <p>Seit 1992 bis zum Jahr 2014 fand jährlich am Todestag Silvio Meiers eine Gedenkdemonstration in Berlin-Friedrichshain statt, die meist mit aktuellen Anlässen verbunden wurde. Am Tatort, dem U-Bahnhof Samariterstraße, erinnert heute eine Gedenktafel an Silvio Meier. Kurze Zeit nach der Tat von Freund:innen Silvio Meiers angebracht, wurde die Tafel mehrfach beschädigt und entwendet, bis sie im Jahr 2007 schließlich von den Berliner Verkehrsbetrieben fest im Beton verankert wurde.</p>
                            <p>Seit 2013 erinnert zudem eine Straße an Silvio Meier. Auf Druck von Gedenkinitiativen wurde die Gabelsbergerstraße in Berlin-Friedrichshain im Jahr 2013 schließlich umbenannt in Silvio-Meier-Straße. Über dem Straßenschild steht: „Engagiert in der unabhängigen DDR-Friedens- und Menschenrechtsbewegung und Hausbesetzer, wurde aufgrund seines antifaschistischen Auftretens ermordet“. Seine damalige Lebensgefährtin sagte dazu: „Wir Freunde haben […] gesagt, das muss mit auf das Schild. Silvio war eben auch Besetzer. Und noch viel mehr: Freund, Antifaschist, Teil der Opposition in der DDR.“</p>
                        `,
                        'source': 'Amadeu Antonio Stiftung - Silvio Meier'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4658, 52.5144] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'eugeniu_botnari',
                        'category': 'erinnerung',
                        'title': 'Eugeniu Botnari (*1982 – †2016)',
                        'year': 2016,
                        'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/03/Gedenktafel_Eugeniu-Botnari-Platz_%28Rumbg%29_Eugeniu_Botnari.jpg',
                        'description': `
                            <h4>Der Angriff</h4>
                            <p>Am 20. September 2016 starb Eugeniu Botnari im Alter von 34 Jahren an den Folgen eines Schädel-Hirn Traumas, das ihm bei einem rassistisch und sozialdarwinistisch motivierten Angriff zugeführt wurde. Drei Tage zuvor, am Morgen des 17. September 2016, besuchte er eine Edeka-Filiale im Bahnhof Berlin-Lichtenberg. Der Filialleiter André S. beobachtete ihn und warf ihm vor, Ladendiebstahl begangen zu haben. Statt die Polizei zu rufen, führte der Filialleiter Eugeniu Botnari in den Durchgang des Getränkelagers im hinteren Teil des Geschäfts. Dort zog er sich einen Quarzhandschuh an und schlug damit auf Eugeniu Botnari ein. Danach zog der Täter Eugeniu Botnari über eine Hintertür aus dem Geschäft. Die gesamte Tat wurde von der Überwachungskamera des Supermarktes aufgezeichnet.</p>
                            
                            <h4>Sozialdarwinistisches Motiv</h4>
                            <p>Der Filialleiter filmte das Überwachungsvideo nach der Tat mit seinem Handy ab und verschickte es, versehen mit menschenverachtenden Kommentaren, an seine Mitarbeiter:innen. Eugeniu Botnari ging nicht zum Arzt, weil er Angst vor Behandlungskosten hatte.</p>
                            
                            <h4>Urteil und Einordnung</h4>
                            <p>Am 27. März 2017 wurde André S. vor dem Landgericht Berlin wegen Körperverletzung mit Todesfolge zu einer Haftstrafe von drei Jahren und drei Monaten verurteilt. Laut zivilgesellschaftlichen Initiativen, die den Gerichtsprozess beobachteten, wurde in der Verhandlung klar, dass André S. ähnliche Taten schon mehrfach verübt hatte und seine Quarzhandschuhe regelmäßig gegen vermeintliche Diebe, die er als „Ausländer“ wahrnahm, einsetzte. Die meisten davon waren Wohnungslose.</p>
                            <p>Vor Gericht sagte André S. aus, er habe Eugeniu Botnari eine Lektion erteilen wollen. Seine Aussagen offenbarten sein rassistisches und sozialdarwinistisches Weltbild. Der Richter nannte das Verschicken des Videos in seiner Urteilsbegründung „zynisch und menschenverachtend“. Trotzdem wurde die Tat offiziell nicht als politische Tat anerkannt.</p>
                            
                            <h4>Gedenken</h4>
                            <p>Im April 2023 wurde der zuvor namenslose Vorplatz des Bahnhofs Berlin-Lichtenberg nach Eugeniu Botnari benannt und eine Gedenktafel errichtet.</p>
                        `,
                        'source': 'Amadeu Antonio Stiftung - Eugeniu Botnari'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4975, 52.5098] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'kaethe_tucholla',
                        'category': 'erinnerung',
                        'title': 'Käthe Tucholla (*1910 – †1943)',
                        'year': 1943,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Kaskelkiez_Kaskelstr_Gedenktafel_Tucholla.JPG',
                        'description': `
                            <h4>Leben und Politisierung</h4>
                            <p>Käthe Scheffler wächst in Berlin-Lichtenberg auf und arbeitet nach der Schulausbildung als Sekretärin. In ihrer Frei­zeit spielt sie Hockey im Ar­bei­ter­sport­ver­ein Sparta Lich­ten­berg. Dort lernt sie auch ihren späteren Mann, den Fußballer und Schlosser Felix Tucholla, kennen. Dieser gehört seit 1928 der KPD an und ist Leiter der KPD-Zelle in der Rümmelsbürger Lessestraße (heute Spittastraße). Die beiden heirateten 1940.</p>
                            
                            <h4>Widerstand gegen das NS-Regime</h4>
                            <p>Ab 1939 engagiert sich das Paar in der Widerstandsgruppe um Robert Uhrig. Sie verbreiten Flugschriften und beschaffen Lebensmittelkarten für untergegangene Regimegegner.</p>
                            <p>Im Juni 1942 unterstützen sie den aus der Sowjetunion über Ostpreußen abgesprungenen Fallschirmjäger Erwin Panndorf nach seinem Eintritt in Berlin und besorgen ihm unter Mit Hilfe von Rudolf Scheffel wechselnde Unterkünfte. Käthe Tucholla reist mehr­mals nach Meerane in Sach­sen, um für Erwin Panndorf Kon­tak­te wie­der­her­zu­stel­len.</p>
                            
                            <h4>Verhaftung und Ermordung</h4>
                            <p>Bei einem dieser Treffen wird sie am 25. Juli 1942 festgenommen. Käthe und Felix Tucholla werden am 17. August 1943 vom „Volks­ge­richts­hof” wegen „Vor­be­rei­tung zum Hoch­ver­rat” zum Tode ver­ur­teilt.</p>
                            <p>Ihr Mann wird am 8. September 1943 während der sogenannten Blutnächte und Käthe Tucholla drei Wochen später, am 28. September 1943, im Strafgefängnis Berlin-Plötzensee ermordet.</p>
                        `,
                        'source': 'Frauen im Widerstand - Käthe Tucholla'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4832, 52.5038] }
                },

                // === KATEGORIE 2: ORTE DES WIDERSTANDS (Aktuelle Initiativen) ===
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'bunter_wind',
                        'category': 'widerstand',
                        'title': 'Bunter Wind für Lichtenberg (seit 2012)',
                        'year': 2012,
                        'locked': true,
                        'image': 'https://raw.githubusercontent.com/gaspardellanuit/Lichtenbergaustellung/refs/heads/main/Bunter_Wind_LOGO-1.jpg',
                        'description': `
                            <h4>Engagement für Demokratie</h4>
                            <p>Der Bunte Wind setzt seit seiner Gründung 2012 wichtige Impulse für eine offene und demokratische Gesellschaft in Lichtenberg. Angesichts der aktuellen Herausforderungen stärkt die Organisation den Zusammenhalt und die Solidarität in der Zivilgesellschaft, um Vielfalt, Respekt und demokratische Werte zu fördern.</p>
                            
                            <h4>Ziele und Werte</h4>
                            <p>Das Ziel lautet: Solidarisch für eine starke und lebendige Demokratie! Mit Solidarität, Zusammenhalt und Gleichberechtigung gegen jede Form von Diskriminierung und Ausgrenzung ein. Es gibt zwar keine einfachen Lösungen für soziale und politische Konflikte, doch werden hier auf gewaltfreie, respektvolle und solidarische Ansätze gesetzt. Jede Person sollte die Möglichkeit haben, ihr Lebensumfeld aktiv mitzugestalten. Meinungsfreiheit bedeutet nicht, dass jede Äußerung unwidersprochen bleibt. Damit alle ein selbstbestimmtes Leben führen können, ist es wichtig, Vielfalt zu schätzen und zu schützen.</p>
                            
                            <h4>Willkommenskultur</h4>
                            <p>Der Bunte Wind kennt keine Grenzen. Menschen, die neu nach Lichtenberg kommen, werden willkommen geheißen und mit Respekt begegnet. Was uns verbindet, ist der Einsatz gegen rassistische und diskriminierende Hetze sowie das Engagement für Menschlichkeit und Menschenrechte!</p>
                            
                            <p><strong>Adresse:</strong> Einbecker Straße 85, 10315 Berlin</p>
                        `,
                        'source': 'Bunter Wind für Lichtenberg – Aufruf <a href="https://bunterwind-lichtenberg.org/aufruf/" target="_blank" style="color:#FF00FF">bunterwind-lichtenberg.org</a>'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'licht_blicke',
                        'category': 'widerstand',
                        'title': 'Licht-Blicke (seit 2002)',
                        'year': 2002,
                        'locked': true,
                        'image': 'https://raw.githubusercontent.com/gaspardellanuit/Lichtenbergaustellung/9f9a07301a755529d848be03eccd3ee1e32b91c1/licht%20blicke.png',
                        'description': `
                            <h4>Netzwerkstelle für Demokratie</h4>
                            <p>Licht-Blicke besteht aus folgenden Projekten: Koordinierungsstelle der Partnerschaften für Demokratie in den Fördergebieten Lichtenberg und Hohenschönhausen, Netzwerkstelle für Kinder- und Jugendpartizipation und die Koordination des bezirklichen Runden Tischs für Politische Bildung. Außerdem ist der Arbeitskreis Stolpersteine Lichtenberg/Hohenschönhausen fachlich und organisatorisch bei Licht-Blicke angesiedelt.</p>
                            
                            <h4>Schnittstelle zwischen Zivilgesellschaft und Politik</h4>
                            <p>An der Schnittstelle zwischen Politik, Verwaltung und Zivilgesellschaft sieht die Fach- und Netzwerkstelle zudem eine besondere Aufgabe darin, zur Förderung einer demokratischen Kultur im Gemeinwesen beizutragen. Diese Vernetzung ist ein wichtiges Arbeitsfeld, um bedarfsorientierte Beratung sowie die Entwicklung und Anpassung von Handlungskonzepten zu gewährleisten.</p>
                            
                            <h4>Aufgabenbereiche</h4>
                            <ul>
                                <li>Förderung der aktiven Beteiligung von Menschen aller Altersgruppen in Lichtenberg für ein offenes und solidarisches Gemeinwesen in engem Kontakt mit den Akteur_innen vor Ort</li>
                                <li>Unterstützung von Initiativen, Einrichtungen, Fachkräften und Privatpersonen in ihrem Engagement für demokratische Werte und Menschenrechte</li>
                                <li>Stärkung der Achtsamkeit gegenüber Demokratie gefährdende Entwicklungen und Einstellungspotentialen</li>
                                <li>Unterstützung und Begleitung lokalen Engagements gegen extreme Rechte, Rechtspopulismus und Rassismus mit dem Ziel, für extrem rechte und diskriminierende Phänomene zu sensibilisieren</li>
                                <li>Förderung eines Diversitätsbewusstseins in der Mehrheitsgesellschaft und diskriminierungskritische Begleitung gesellschaftspolitischer Aushandlungsprozesse</li>
                                <li>Initiierung und vertrauliche Begleitung von Teams und Gruppen im Umgang mit Diskriminierungen (zum Beispiel Verständigungsprozesse und Leitbildentwicklung)</li>
                                <li>Fachliche Initiierung und Begleitung von Kinder- und Jugendpartizipationsstrukturen sowie -projekten gemeinsam mit lokalen Partner_innen</li>
                                <li>Begleitung von lokalen Akteuren bei der Recherche zu und der Verlegung von „Stolpersteinen“, die an Opfer des Nationalsozialismus erinnern sowie die Begleitung von Projektschultagen zum Themenfeld</li>
                                <li>Fachliche Koordinierung und Begleitung des Runden Tisches Politische Bildung in Lichtenberg und Umsetzung in lokalspezifischer Maßnahmen in Politische Bildungsarbeit</li>
                            </ul>
                        `,
                        'source': 'Licht Blicke'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5205, 52.4962] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'berliner_register',
                        'category': 'widerstand',
                        'title': 'Berliner Register (seit 2005)',
                        'year': 2005,
                        'locked': true,
                        'image': 'https://raw.githubusercontent.com/gaspardellanuit/Lichtenbergaustellung/9f9a07301a755529d848be03eccd3ee1e32b91c1/berliner%20register.png',
                        'description': `
                            <h4>Dokumentation von Diskriminierung</h4>
                            <p>Die Berliner Register gehen vor gegen Diskriminierung und Ausgrenzung. Das machen sie, indem sie Vorfälle dokumentieren, die im Alltag in Berlin passieren. Es werden nur Vorfälle aufgenommen, die rassistisch, antisemitisch, LGBTIQ*-feindlich, antiziganistisch, extrem rechts, sozialchauvinistisch, behindertenfeindlich oder antifeministisch sind. Die Vorfälle werden von Bürger*innen über verschiedene Wege an das Register des jeweiligen Berliner Bezirks geschickt. Die Berliner Register sammeln und prüfen die Meldungen, veröffentlichen sie als Einträge in einer Chronik und werten sie einmal jährlich aus. Die Ergebnisse können Politiker*innen, Mitarbeiter*innen der Verwaltung oder politisch engagierte Initiativen in ihre Entscheidungen einbeziehen und dann Maßnahmen entwickeln, um gezielt gegen Diskriminierung und Ausgrenzung vorzugehen.</p>
                            
                            <h4>Was wird dokumentiert?</h4>
                            <p>In die Dokumentation der Berliner Register fließen Vorfälle ein, die Bürger*innen im Alltag beobachten oder selbst erleben. Bei den Vorfällen handelt es sich um Aktivitäten der extremen Rechten, um rassistische Vorfälle im Alltag und Diskriminierung an verschiedenen Orten. Im Gegensatz zur Kriminalitätsstatistik der Polizei beziehen die Register auch Vorfälle in die Dokumentation ein, die keine Straftaten sind oder die nicht angezeigt wurden. Dazu gehören Gewalttaten, Beleidigungen und Bedrohungen, Brandstiftungen, Sachbeschädigungen, Veranstaltungen, Aufkleber, Sprühereien oder diskriminierende Sprüche.</p>
                            
                            <h4>Solidarität und Sichtbarkeit</h4>
                            <p>Berliner*innen leben, bewegen und engagieren sich in ihren Kiezen. Mit der Veröffentlichung eines Vorfalls wird für alle sichtbar, auf welche Weise Menschen in Berlin im Alltag Ausgrenzung erleben. Solche Vorfälle aufzunehmen ermöglicht den Betroffenen, ihre Erlebnisse zu schildern und mit ihren Problemen nicht allein zu sein. Durch die Veröffentlichung der Vorfälle und die aktive Beteiligung der Bürger*innen am Register wächst das Interesse für die Problematik der Diskriminierung, insbesondere in der eigenen Nachbarschaft. Das Gefühl, auch selbst betroffen sein zu können, die Betroffenen zu kennen oder den Tatort, erzeugt Solidarität mit jenen Menschen, die Diskriminierung und Ausgrenzung erfahren.</p>
                        `,
                        'source': 'Berliner Register'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5058, 52.5115] }
                },

                // === KATEGORIE 3: ORTE DES GEDENKENS (Historische Orte) ===
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rummelsburg',
                        'category': 'gedenken',
                        'title': 'Gedenkort Rummelsburg (1933 – 1990)',
                        'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/7/71/Skulptur_Hauptstr_8_%28Rumbg%29_Gef%C3%A4ngnis_Rummelsburg%26Helga_Lieser%262015.jpg',
                        'description': `
                            <h4>NS-Zeit: Verfolgung von "Asozialen"</h4>
                            <p>1879 eröffnete in Rummelsburg ein „Arbeitshaus“, um Angehörige sozialer Randgruppen wie Bettler, Obdachlose und Prostituierte unterzubringen und als billige Arbeitskräfte zu nutzen. Diese Randgruppen wurden mit dem Machtantritt der Nationalsozialisten 1933 als „Asoziale“ massiv verfolgt und in Rummelsburg gegen ihren Willen festgehalten. 1939 waren in Rummelsburg etwa 2.000 Menschen inhaftiert.</p>
                            
                            <h4>"Euthanasie"-Verbrechen</h4>
                            <p>Am 13. Januar 1941 wurden alle 30 jüdischen Insassen im Rahmen einer »Sonderaktion« der NS-»Euthanasie« in ein Krankenhaus nach Buch verlegt. Vier Tage später wurden sie mit einem Bus zur Heilanstalt Bernburg gebracht, wo sie mit Gas ermordet wurden. Bernburg war zu diesem Zeitpunkt eine Tötungsanstalt der »Aktion T4«, die sich gezielt gegen Patienten und Kranke richtete. Es wurden Sonderabteilungen eingerichtet, etwa für Homosexuelle, zudem sind 124 Zwangssterilisierungen dokumentiert.</p>
                            <p>Im Januar 1942 besuchte eine die im Rahmen der NS-»Euthanasie« gebildete Kommission Rummelsburg und selektierte 314 Insassen zur Tötung. Dieser geplante Massenmord wurde schließlich nicht umgesetzt.</p>
                            
                            <h4>DDR-Zeit: Politisches Gefängnis</h4>
                            <p>Nach 1945 einige Jahre wieder als Arbeitshaus benutzt, wurde Rummelsburg in der Zeit der DDR in ein Gefängnis umgebaut. In der DDR galt »Asozialität« weiterhin als Verhaftungsgrund. Unter den Häftlingen von Rummelsburg waren viele aus politischen Gründen inhaftiert, insbesondere nach dem Volksaufstand 1953, dem Mauerbau 1961 und während der Wochen der Friedlichen Revolution von 1989.</p>
                            
                            <h4>Gedenkort</h4>
                            <p>Im Oktober 1990 wurde das marode Gefängnis geschlossen. Nach jahrelangem Lehrstand setzten sich zivilgesellschaftliche Initiativen wie Marginalisierte – Gestern und Heute für die Aufarbeitung dieser Geschichte ein. 2015 eröffnete ein Gedenk- und Informationsort. Die Häuser wurden zu Wohnraum umfunktioniert.</p>
                        `,
                        'source': 'Memorial Museums - Gedenkort Rummelsburg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4827, 52.4941] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rote_kapelle',
                        'category': 'gedenken',
                        'title': 'Die Rote Kapelle (1940 – 1942)',
                        'year': 1940,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/Skulptur_Schulze-Boysen-Str_12_%28Liber%29_B%C3%BCrger_im_Widerstand%26Achim_K%C3%BChn%2620112.jpg',
                        'description': `
                            <h4>Ein breites Netzwerk</h4>
                            <p>Die Rote Kapelle gehörte zu den größten antifaschistischen Widerstandsgruppierungen. Durch persönliche Kontakte bildete sich 1940/41 ein loses Netzwerk von sieben Berliner Freundes- und Widerstandskreisen heraus. Ihnen gehörten mehr als 150 Regimegegner unterschiedlicher sozialer Herkunft und Weltanschauungen an, darunter sehr viele Frauen. Freundschaft und Nazigegnerschaft gehörten oftmals zusammen. Arbeiter, Angestellte, Unternehmer, Intellektuelle, Künstler, Ärzte, Soldaten und Offiziere, Marxisten und Christen diskutierten politische und künstlerische Fragen, halfen politisch und jüdisch Verfolgten sowie Zwangsarbeitern, dokumentierten NS-Gewaltverbrechen und riefen in Flugschriften und Zettelklebeaktionen zum Widerstand auf.</p>
                            
                            <h4>Warnung an die Alliierten</h4>
                            <p>Der Oberregierungsrat im Wirtschaftsministerium, Arvid Harnack, unterhielt Kontakte zur amerikanischen und sowjetischen Botschaft. Gemeinsam mit dem Oberleutnant im Reichsluftwaffenministerium Harro Schulze-Boysen informierte er über die Vorbereitungen des Angriffs auf die Sowjetunion. Ihre Warnungen wurden von Stalin als Desinformationen bezeichnet.</p>
                            
                            <h4>Verfolgung und Hinrichtung</h4>
                            <p>Im Herbst 1942 nahm die Gestapo über 120 Verdächtige fest und ordnete sie unter dem Namen „Rote Kapelle“ einem besonderen Fahndungskomplex zu. Das Reichskriegsgericht und der Volksgerichtshof verurteilten über 90 Frauen und Männer. Von ihnen wurden 50 zum Tode verurteilt, ermordet oder starben in der Haft. Viele waren jung und alle liebten das Leben. Hilde Coppi und Liane Berkowitz hatten zuvor im Frauengefängnis Barnimstraße ihre Kinder zur Welt gebracht.</p>
                            
                            <h4>Erinnerung</h4>
                            <p>Heute ist die Rote Kapelle Sinnbild für Zivilcourage und engagiertes Eintreten für Menschlichkeit und Menschenwürde. Dieser Gedenkort entstand auf Anregung der Bürgerschaft dieses Wohngebietes, in dem seit 1972 drei Schulen und sechs Straßen die Namen von Mitstreitern der Rote Kapelle Hilde und Hans Coppi, Wilhelm Guddorf, Mildred und Arvid Harnack, Albert Hößler, Libertas und Harro Schulze-Boysen sowie John Sieg tragen.</p>
                        `,
                        'source': 'Gedenktafeln in Berlin'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4872, 52.5138] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'loeperplatz',
                        'category': 'gedenken',
                        'title': 'Ehrenmal für die Opfer des Faschismus am Loeperplatz (1933 – 1945)',
                        'year': 1948,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Loeperplatz_VDN_1.jpg',
                        'description': `
                            <h4>Ein frühes Denkmal</h4>
                            <p>Auf dem Loeperplatz, dem Dorfanger des früheren Dorfes Lichtenberg, befindet sich gegenüber der Alten Pfarrkirche Lichtenberg ein Denkmal für die Opfer des Faschismus. Dieses Denkmal wurde vermutlich bereits 1948 errichtet und gehört damit zu einem der ersten Denkmäler für die Opfer des Faschismus in Berlin überhaupt. Vermutlich erfolgte der Bau des Denkmals auf Initiative der Vereinigung der Verfolgten des Naziregimes (VVN). Über die weiteren Zusammenhänge der Entstehung des Denkmals ist trotz intensiver Nachforschungen nichts bekannt.</p>
                            
                            <h4>Symbolik des roten Winkels</h4>
                            <p>Das Denkmal besteht aus einem großen Steinquader, auf dem eine auf die Spitze gestellte rote Pyramide steht. Auf ihr stehen die Buchstaben »KZ«. Die Pyramide symbolisiert den roten Winkel, mit dem politische Häftlinge in den Konzentrationslagern (KZ) von der SS gekennzeichnet wurden. Der rote Winkel mit den Buchstaben »KZ« war ein gebräuchliches Symbol auf Plakaten, Publikationen und Denkmälern der OdF-Hauptausschüsse (OdF: Opfer des Faschismus), einem Zusammenschluss Überlebender, die von den Nationalsozialisten verfolgt wurden, und Vorläufer der VVN.</p>
                            <p>Das Denkmal wurde vermutlich 1948 errichtet und in den 1960er Jahren erneuert. Am Denkmal finden regelmäßig Gedenkveranstaltungen statt.</p>
                        `,
                        'source': 'Memorial Museums'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4795, 52.5238] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rathaus',
                        'category': 'gedenken',
                        'title': 'Rathaus Lichtenberg - Gedenktafel für verfolgte Politiker (1933)',
                        'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg',
                        'description': `
                            <h4>Verfolgung von Amtsinhabern</h4>
                            <p>Rechts neben dem Eingangsportal zum Ratssaal befindet sich eine Gedenktafel. Sie erinnert an diejenigen Bezirks- und Stadtverordneten Lichtenbergs, die von den Nationalsozialisten ihrer Ämter enthoben und verfolgt wurden. Bereits unmittelbar nach der Ernennung Adolf Hitlers zum Reichskanzler am 30. Januar 1933 erlebten kommunistische, sozialdemokratische und jüdische Amtsträger Gewalt und Verfolgung. So wurde beispielsweise der kommunistische Bezirkspolitiker und Reichstagsabgeordnete Ernst Torgler im Reichstagsbrandprozess angeklagt, mangels Beweise jedoch freigesprochen. Er saß dennoch bis 1936 im Konzentrationslager in „Schutzhaft“.</p>
                            
                            <h4>Säuberung der Verwaltung</h4>
                            <p>Nach den Kommunalwahlen in Berlin am 12. März 1933 begann eine umfassende Säuberung der kommunalen und bezirklichen Verwaltung. Davon waren auch Mitglieder republikanischer Parteien betroffen, die nicht bereit waren, sich anzupassen. Dazu zählt unter anderem Johannes Fest, Bezirksverordneter und Mitglied des Vorstands der Berliner Zentrums-Partei. Er wurde beurlaubt und mit einem Berufsverbot belegt, weil er sich weigerte, in die NSDAP einzutreten.</p>
                            
                            <h4>Widerstand und Opfer</h4>
                            <p>Viele der auf der Gedenktafel genannten Personen waren im Widerstand gegen den Nationalsozialismus aktiv und zahlten dafür oft einen hohen Preis. Die Sozialfürsorgerin Frieda Rosenthal wurde 1936 verhaftet. Sie nahm sich im Gefängnis das Leben, nachdem sie unter Folter den Kontakt zu einem weiteren Widerstandskämpfer zugegeben hatte.</p>
                        `,
                        'source': 'Bezirksamt Lichtenberg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4798, 52.5155] }
                }
            ]
        };

        // ------------------------------------------------------------------
        // 2. STATE
        // ------------------------------------------------------------------
        let state = {
            discovered: [],
            required: 6,
            unlocked: false,
            scanner: null,
            lastScannedId: null
        };

        const map = new mapboxgl.Map({
            container: 'map', style: 'mapbox://styles/mapbox/dark-v11',
            center: [13.485, 52.51], zoom: 12.5, pitch: 45,
            bearing: -10
        });

        // ------------------------------------------------------------------
        // 3. START EXHIBITION (SAFE INIT)
        // ------------------------------------------------------------------
        function startExhibition() {
            // Remove start screen IMMEDIATELY
            document.getElementById('start-screen').style.display = 'none';
            
            // Try init scanner, but don't block app if it fails
            setTimeout(initScanner, 500);
        }

        function initScanner() {
            try {
                if(!state.scanner) state.scanner = new Html5Qrcode("reader");
                state.scanner.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: 80 }, 
                    onScanSuccess
                ).catch(err => {
                    console.log("Scanner Error (Camera not allowed?):", err);
                });
            } catch(e) {
                console.log("Scanner Lib Error:", e);
            }
        }

        function onScanSuccess(decodedText) {
            let foundId = null;
            for(let feat of geoData.features) {
                if(decodedText.includes(feat.properties.id)) {
                    foundId = feat.properties.id;
                    break;
                }
            }

            if(foundId && foundId !== state.lastScannedId) {
                state.lastScannedId = foundId;
                state.scanner.pause();
                
                const overlay = document.getElementById('scan-hit-overlay');
                overlay.style.display = 'flex';
                document.getElementById('mini-scanner').style.borderColor = "#00E676";
            }
        }

        function executeScanAction() {
            const id = state.lastScannedId;
            const feature = geoData.features.find(f => f.properties.id === id);
            
            if(feature) {
                if (!state.discovered.includes(id)) {
                    state.discovered.push(id);
                    updateProgress();
                }
                
                if (feature.properties.locked) {
                    unlockAll();
                } else {
                    document.getElementById('year-slider').value = feature.properties.year;
                    document.getElementById('year-display').innerText = feature.properties.year;
                    updateMap(feature.properties.year);
                }
                handleMarker(feature.properties, feature.geometry.coordinates);
            }

            setTimeout(() => {
                document.getElementById('scan-hit-overlay').style.display = 'none';
                document.getElementById('mini-scanner').style.borderColor = "#444";
                state.lastScannedId = null;
                state.scanner.resume();
            }, 1000);
        }

        // ------------------------------------------------------------------
        // 4. MAP LOGIC
        // ------------------------------------------------------------------
        map.on('load', () => {
            map.addSource('path-source', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
            map.addLayer({ 'id': 'path-glow', 'type': 'line', 'source': 'path-source', 'paint': { 'line-color': '#00FFFF', 'line-width': 10, 'line-opacity': 0.3, 'line-blur': 4 } });
            map.addLayer({ 'id': 'path-core', 'type': 'line', 'source': 'path-source', 'paint': { 'line-color': '#00FFFF', 'line-width': 3, 'line-dasharray': [2, 1] } });

            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;
            map.addLayer({ 'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'filter': ['==', 'extrude', 'true'], 'type': 'fill-extrusion', 'paint': { 'fill-extrusion-color': '#222', 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-opacity': 0.9 } }, labelLayerId);

            map.addSource('markers', { 'type': 'geojson', 'data': geoData });
            
            // GLOW LAYER (Enhanced)
            map.addLayer({ 
                'id': 'marker-glow', 
                'type': 'circle', 
                'source': 'markers', 
                'paint': { 
                    'circle-radius': 70, 
                    'circle-color': ['match', ['get', 'category'], 'erinnerung', '#00E676', 'gedenken', '#00BFFF', 'widerstand', '#FF00FF', '#fff'], 
                    'circle-opacity': 0.5, 'circle-blur': 0.5 
                } 
            });
            
            map.addLayer({ 'id': 'marker-core', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 10, 'circle-color': '#fff', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } });

            map.on('click', 'marker-core', (e) => handleMarker(e.features[0].properties, e.features[0].geometry.coordinates));
            map.on('mouseenter', 'marker-core', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'marker-core', () => map.getCanvas().style.cursor = '');

            // Deep Link (Manual Scan)
            const urlParams = new URLSearchParams(window.location.search);
            const evt = urlParams.get('event');
            if(evt) {
                document.getElementById('start-screen').style.display = 'none'; // skip start screen
                const t = geoData.features.find(f => f.properties.id === evt);
                if(t) handleMarker(t.properties, t.geometry.coordinates);
            }

            updateMap(1933);
        });

        function handleMarker(props, coords) {
            if (props.locked && !state.unlocked) { openSidebarLocked(); return; }
            if (!state.discovered.includes(props.id) && !props.locked) { state.discovered.push(props.id); updateProgress(); }
            
            const isPortrait = window.innerHeight > window.innerWidth;
            const offset = isPortrait ? [0, -200] : [-200, 0];
            map.flyTo({ center: coords, zoom: 16, pitch: 60, offset: offset, speed: 0.8 });
            openSidebar(props);
        }

        function updateProgress() {
            const pct = Math.min((state.discovered.length / state.required) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            if (state.discovered.length >= state.required && !state.unlocked) {
                setTimeout(unlockAll, 1000);
            }
        }

        function unlockAll() {
            state.unlocked = true;
            document.getElementById('lock-status').innerText = "FREIGESCHALTET";
            document.getElementById('lock-status').style.color = "#00E676";
            document.getElementById('progress-bar').style.background = "#00E676";
            document.getElementById('year-slider').value = 2026;
            document.getElementById('year-display').innerText = 2026;
            updateMap(2026);
        }

        const slider = document.getElementById('year-slider');
        slider.addEventListener('input', (e) => {
            const year = parseInt(e.target.value);
            document.getElementById('year-display').innerText = year;
            updateMap(year);
        });

        function updateMap(year) {
            const filter = ['<=', ['get', 'year'], year];
            map.setFilter('marker-glow', filter);
            map.setFilter('marker-core', filter);
            
            const visible = geoData.features.filter(f => f.properties.year <= year);
            visible.sort((a,b) => a.properties.year - b.properties.year);
            const coords = visible.map(f => f.geometry.coordinates);
            if(map.getSource('path-source')) map.getSource('path-source').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': coords } });
        }

        function openSidebar(data) {
            const content = document.getElementById('sidebar-content');
            const colors = { 'erinnerung': '#00E676', 'gedenken': '#00BFFF', 'widerstand': '#FF00FF' };
            content.innerHTML = `<img src="${data.image}" class="hero-img"><div class="sidebar-content"><span class="cat-tag" style="border-color:${colors[data.category]}; color:${colors[data.category]}">${data.category.toUpperCase()}</span><h2>${data.title}</h2><div class="article">${data.description}</div><div class="source">Quelle: ${data.source}</div></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function openSidebarLocked() {
            document.getElementById('sidebar-content').innerHTML = `<div class="locked-view"><div class="locked-icon">🔒</div><h2 style="color:#FF3D00">DATEN VERSCHLÜSSELT</h2><p>Erforschen Sie erst die Geschichte.</p></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            map.easeTo({ offset: [0, 0] });
        }
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered!'))
                    .catch(err => console.log('Service Worker failed:', err));
            });
        }
    </script>
</body>
</html>
