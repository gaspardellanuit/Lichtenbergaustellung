<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Museum Lichtenberg: Orte des Widerstands</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Colors */
            --bg-color: #050505;
            --text-main: #ffffff;
            --c-erinnerung: #D4AF37;   /* Gold - Memory */
            --c-gedenken: #A0A0A0;     /* Silver - Commemoration */
            --c-widerstand: #00E676;   /* Neon Green - Resistance */
            --c-heute: #FF3D00;        /* Neon Red - Today */
            --c-path: #00FFFF;         /* Cyan Path */

            /* Fonts */
            --font-head: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
            
            /* Dimensions */
            --sidebar-width: 500px;
        }

        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-body); overflow: hidden; }

        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .start-btn {
            background: var(--c-widerstand); color: black; border: none;
            padding: 15px 50px; border-radius: 30px;
            font-family: var(--font-head); font-weight: bold; font-size: 1.2rem;
            cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 30px var(--c-widerstand);
            transition: transform 0.2s;
        }
        .start-btn:active { transform: scale(0.95); }

        /* --- UI LAYER --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Vignette for cinematic look */
        .vignette-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 5; 
            background: radial-gradient(circle at center, transparent 30%, rgba(0,0,0,0.8) 60%, rgba(0,0,0,1) 90%); 
        }

        /* HEADER */
        header { 
            position: absolute; top: 30px; left: 30px; pointer-events: auto;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            z-index: 20;
        }
        .museum-label { 
            font-family: var(--font-head); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; 
            color: #aaa; margin-bottom: 5px; font-weight: 500; border-left: 3px solid var(--c-widerstand); padding-left: 10px;
        }
        h1 { 
            font-family: var(--font-head); font-size: 3rem; margin: 0; line-height: 0.9; font-weight: 700;
            color: white; letter-spacing: -1px;
        }

        /* --- MINI SCANNER (Lowered Position) --- */
        #mini-scanner-wrapper {
            position: absolute; 
            top: 260px; /* Moved down to avoid covering title */
            left: 30px; 
            width: 140px; height: 140px;
            background: #000;
            border: 2px solid #444;
            border-radius: 12px;
            overflow: hidden;
            z-index: 50; 
            pointer-events: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,1);
            display: flex; flex-direction: column;
            transition: border-color 0.3s;
        }
        
        #reader { flex: 1; width: 100%; height: 100%; object-fit: cover; }
        
        .scanner-label {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: #fff;
            font-size: 10px; text-align: center; padding: 4px;
            font-family: var(--font-head); letter-spacing: 1px;
            pointer-events: none;
        }

        /* HIT OVERLAY (Inside Scanner) */
        #scan-hit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 230, 118, 0.9); /* Green */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; z-index: 55;
        }
        .hit-icon { font-size: 30px; color: black; font-weight: bold; }
        .hit-text { font-size: 12px; color: black; font-family: var(--font-head); font-weight: bold; margin-top: 5px; }

        /* TIMELINE */
        #timeline-ui {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 900px; min-width: 320px; 
            pointer-events: auto; text-align: center;
            background: rgba(10, 10, 10, 0.85); padding: 15px 40px; border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(8px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #year-display { 
            font-family: var(--font-head); font-size: 2.5rem; font-weight: 700; display: block; 
            margin-bottom: 5px; line-height: 1; color: white;
        }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #000; margin-top: -8px; transition: transform 0.1s; }
        .ticks { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; font-size: 0.8rem; color: #ccc; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-head); }
        .ticks span { text-align: center; flex: 1; }
        .ticks span:first-child { text-align: left; }
        .ticks span:last-child { text-align: right; }

        /* STATUS */
        #status-panel {
            position: absolute; top: 30px; right: 30px; width: 240px; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; border: 1px solid #333;
        }
        .status-header { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .progress-bar { width: 100%; height: 4px; background: #333; margin-top: 8px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--c-widerstand); width: 0%; transition: width 0.5s; box-shadow: 0 0 8px var(--c-widerstand); }
        .lock-text { text-align: right; font-family: var(--font-head); font-size: 0.9rem; color: #666; margin-top: 5px; }

        /* LEGEND */
        #legend { 
            position: absolute; bottom: 30px; left: 30px; pointer-events: auto; 
            display: flex; flex-direction: column; gap: 8px;
        }
        .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #ccc; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        /* SIDEBAR */
        #sidebar {
            position: absolute; right: 0; top: 0; bottom: 0; width: var(--sidebar-width);
            background: #080808; border-left: 1px solid #333; z-index: 60;
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            overflow-y: auto; pointer-events: auto; display: flex; flex-direction: column;
            box-shadow: -20px 0 50px rgba(0,0,0,0.8);
        }
        #sidebar.open { transform: translateX(0); }

        .close-area {
            position: sticky; top: 0; width: 100%; height: 70px; z-index: 50;
            display: flex; justify-content: flex-end; align-items: center; padding-right: 25px;
            background: linear-gradient(to bottom, rgba(8,8,8,1) 50%, rgba(8,8,8,0));
        }
        .close-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;
            width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .close-btn:hover { background: white; color: black; }

        .sidebar-content { padding: 40px; padding-top: 0; }
        .hero-img { width: 100%; height: 300px; object-fit: cover; border-bottom: 4px solid #333; margin-bottom: 25px; }
        
        .cat-tag { 
            font-family: var(--font-head); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; 
            margin-bottom: 10px; display: inline-block; padding: 4px 8px; border: 1px solid #444; color: #fff;
        }
        
        h2 { font-family: var(--font-head); font-size: 2.2rem; line-height: 1.1; margin: 0 0 25px 0; font-weight: 700; color: white; }
        .article { font-size: 1.05rem; line-height: 1.7; color: #ccc; font-weight: 300; margin-bottom: 40px; }
        .article h3 { color: white; font-family: var(--font-head); font-size: 1.2rem; margin-top: 30px; margin-bottom: 10px; font-weight: 500; border-left: 3px solid var(--c-path); padding-left: 10px; }
        .source { font-size: 0.75rem; color: #666; border-top: 1px solid #222; padding-top: 20px; font-style: italic; }

        .locked-view { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; color: #555; }
        .locked-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }

        @media (max-width: 1024px) {
            :root { --sidebar-width: 100%; }
            #timeline-ui { width: 90%; bottom: 20px; padding: 15px 20px; }
            .sidebar-content { padding: 25px; }
            #mini-scanner-wrapper { top: 200px; left: 20px; }
        }

        .mapboxgl-popup-content { background: #000; color: #fff; border: 1px solid #444; font-family: var(--font-body); padding: 10px 14px; }
        .mapboxgl-popup-close-button { display: none; }

    </style>
</head>
<body class="p-1933">

    <div id="start-screen">
        <h1 style="color:white; margin-bottom: 10px; text-shadow:0 0 20px black;">Museum Lichtenberg</h1>
        <p style="color:#aaa; font-family:var(--font-head);">Orte des Widerstands</p>
        <button class="start-btn" onclick="startApp()">Ausstellung Starten</button>
    </div>

    <div id="map"></div>
    <div class="vignette-overlay"></div>

    <div id="ui-layer">
        <header>
            <div class="museum-label">Museum Lichtenberg</div>
            <h1>Orte des<br>Widerstands</h1>
        </header>

        <div id="mini-scanner-wrapper">
            <div id="reader"></div>
            <div class="scanner-label">SCAN QR</div>
            
            <div id="scan-hit-overlay" onclick="executeScanAction()">
                <div class="hit-icon">‚ûú</div>
                <div class="hit-text">√ñFFNEN</div>
            </div>
        </div>

        <div id="status-panel">
            <div class="status-header">Archiv Fortschritt</div>
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div class="lock-text" id="lock-status">GEGENWART GESPERRT</div>
        </div>

        <div id="legend">
            <div class="legend-item"><div class="dot" style="background:var(--c-erinnerung)"></div> Orte der Erinnerung</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-gedenken)"></div> Gedenken</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-widerstand)"></div> Widerstand</div>
            <div class="legend-item"><div class="dot" style="background:var(--c-heute)"></div> Gegen Rechts Heute</div>
        </div>

        <div id="timeline-ui">
            <span id="year-display">1933</span>
            <input type="range" id="year-slider" min="1933" max="2026" value="1933" step="1">
            <div class="ticks">
                <span>1933</span><span>1990</span><span>2000</span><span>Heute</span>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div class="close-area">
            <button class="close-btn" onclick="closeSidebar()">&times;</button>
        </div>
        <div id="sidebar-content"></div>
    </div>

    <script>
        // ------------------------------------------------------------------
        // 1. DATA (UPDATED WITH PDF CONTENT)
        // ------------------------------------------------------------------
        const geoData = {
            'type': 'FeatureCollection',
            'features': [
                // --- CATEGORY 1: ERINNERUNG (RED/GOLD) ---
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'kurt_schneider', 'category': 'erinnerung', 'title': 'Kurt Schneider (1961‚Äì1999)', 'year': 1999,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/01/Memorial_plaque_metal_Kurt_Schneider_Berlin%2C_Germany.jpg',
                        'description': `<h3>Ein Opfer rechter Gewalt</h3><p>Kurt Schneider wurde 1961 in K√∂nigs Wusterhausen geboren und arbeitete als Maurer. In der Nacht auf den 6. Oktober 1999 wurde er auf dem Heimweg von vier Neonazis √ºberfallen und ermordet. Die T√§ter f√ºhlten sich durch einen Gru√ü "beleidigt" und sahen ihn als "minderwertigen Menschen" an.</p><h3>Sp√§te Anerkennung</h3><p>Lange wurde die Tat entpolitisiert und als Vertuschung eines Raubes gedeutet. Erst 2018 wurde Kurt Schneider offiziell als Todesopfer rechter Gewalt anerkannt. Eine Gedenktafel in der Rudolf-Reusch-Stra√üe erinnert seit 2021 an ihn.</p>`,
                        'source': 'Gedenktafeln in Berlin'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4802, 52.5185] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'silvio_meier', 'category': 'erinnerung', 'title': 'Silvio Meier (1965‚Äì1992)', 'year': 1992,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/1/14/Silvio_Meier.jpg',
                        'description': `<h3>Aktivist und Hausbesetzer</h3><p>Silvio Meier war in der DDR-Opposition aktiv (Kirche von Unten) und nach der Wende Teil der Hausbesetzerszene in der Schreinerstra√üe. Er wurde am 21. November 1992 im U-Bahnhof Samariterstra√üe von Neonazis erstochen.</p><h3>Gedenkkultur</h3><p>Sein Tod politisierte eine ganze Generation. Bis 2014 fanden j√§hrliche Gedenkdemonstrationen statt. Der U-Bahnhof und eine Stra√üe tragen heute Gedenkzeichen.</p>`,
                        'source': 'Amadeu Antonio Stiftung'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4658, 52.5144] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'eugeniu_botnari', 'category': 'erinnerung', 'title': 'Eugeniu Botnari (1982‚Äì2016)', 'year': 2016,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/03/Gedenktafel_Eugeniu-Botnari-Platz_%28Rumbg%29_Eugeniu_Botnari.jpg',
                        'description': `<h3>T√∂dlicher Sozialdarwinismus</h3><p>Im September 2016 wurde der wohnungslose Eugeniu Botnari im Bahnhof Lichtenberg vom Filialleiter eines Supermarktes beschuldigt, gestohlen zu haben, und brutal misshandelt. Er starb an den Folgen.</p><h3>Ein Ort des Gedenkens</h3><p>Der T√§ter handelte aus rassistischen und sozialdarwinistischen Motiven. Seit 2023 tr√§gt der Vorplatz des Bahnhofs Lichtenberg Eugeniu Botnaris Namen.</p>`,
                        'source': 'Amadeu Antonio Stiftung'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4975, 52.5098] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'kaethe_tucholla', 'category': 'erinnerung', 'title': 'K√§the Tucholla (1910‚Äì1943)', 'year': 1943,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Kaskelkiez_Kaskelstr_Gedenktafel_Tucholla.JPG',
                        'description': `<h3>Widerstand im Kiez</h3><p>K√§the Tucholla, eine Sekret√§rin und Hockeyspielerin bei Sparta Lichtenberg, engagierte sich in der KPD-Widerstandsgruppe um Robert Uhrig. Sie verbreitete Flugbl√§tter und unterst√ºtzte Verfolgte.</p><h3>Ermordung in Pl√∂tzensee</h3><p>1942 wurde sie festgenommen und 1943 im Strafgef√§ngnis Pl√∂tzensee hingerichtet. Ihr Wohnhaus in der Kaskelstra√üe erinnert an sie.</p>`,
                        'source': 'Frauen im Widerstand'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4832, 52.5038] }
                },

                // --- CATEGORY 3: GEDENKEN (PURPLE/SILVER) ---
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rummelsburg', 'category': 'gedenken', 'title': 'Gedenkort Rummelsburg', 'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/5/52/Bundesarchiv_Bild_183-1990-0704-026%2C_Berlin%2C_Rummelsburg%2C_M%C3%A4nnerhaftanstalt.jpg',
                        'description': `<h3>Ort der Ausgrenzung</h3><p>Das Arbeitshaus Rummelsburg diente im NS-Staat der Verfolgung von sogenannten "Asozialen". 1941 wurden j√ºdische H√§ftlinge von hier in den Tod deportiert. In der DDR diente es als Gef√§ngnis, auch f√ºr politische H√§ftlinge.</p><h3>Vom Knast zum Wohnraum</h3><p>Heute ist das Gel√§nde ein Wohngebiet, doch ein Gedenkort erinnert an die d√ºstere Geschichte der Ausgrenzung an diesem Ort.</p>`,
                        'source': 'Memorial Museums'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4855, 52.4955] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rote_kapelle', 'category': 'gedenken', 'title': 'Die Rote Kapelle', 'year': 1940,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/c/ca/Skulptur_Schulze-Boysen-Str_12_%28Liber%29_B%C3%BCrger_im_Widerstand%26Achim_K%C3%BChn%2620112.jpg',
                        'description': `<h3>Netzwerk des Widerstands</h3><p>Die Rote Kapelle war eines der gr√∂√üten Widerstandsnetzwerke gegen den NS. √úber 150 Frauen und M√§nner unterschiedlicher Herkunft dokumentierten Verbrechen und warnten die Alliierten.</p><h3>Verfolgung</h3><p>1942 wurde die Gruppe zerschlagen, √ºber 50 Mitglieder ermordet. In Lichtenberg tragen heute viele Stra√üen in der "Schulze-Boysen-Siedlung" ihre Namen.</p>`,
                        'source': 'Gedenktafeln in Berlin'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4872, 52.5138] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'loeperplatz', 'category': 'gedenken', 'title': 'Ehrenmal Loeperplatz', 'year': 1948,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Loeperplatz_VDN_1.jpg',
                        'description': `<h3>Ein fr√ºhes Denkmal</h3><p>Bereits 1948 wurde auf dem Loeperplatz dieses Denkmal f√ºr die Opfer des Faschismus errichtet. Der rote Winkel an der Spitze symbolisiert die Kennzeichnung politischer H√§ftlinge in den Konzentrationslagern.</p>`,
                        'source': 'Memorial Museums'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4795, 52.5238] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'rathaus', 'category': 'gedenken', 'title': 'Gedenktafel Rathaus Lichtenberg', 'year': 1933,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/0/02/Rathaus_Lichtenberg_West-_und_Hauptfassade_2021.jpg',
                        'description': `<h3>Verfolgte Demokratie</h3><p>Eine Tafel am Rathaus erinnert an die Bezirks- und Stadtverordneten, die 1933 von den Nazis ihrer √Ñmter enthoben und verfolgt wurden. Darunter Frieda Rosenthal und Johannes Fest.</p>`,
                        'source': 'Bezirksamt Lichtenberg'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.4798, 52.5155] }
                },

                // --- CATEGORY 2: WIDERSTAND & HEUTE (GREEN/RED) - LOCKED INITIALLY ---
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'bunter_wind', 'category': 'widerstand', 'title': 'LOCKED: Bunter Wind f√ºr Lichtenberg', 'year': 2012, 'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/2/2e/Rathaus_Lichtenberg.jpg', // Placeholder logic used
                        'description': `<h3>Zivilgesellschaft heute</h3><p>Seit 2012 setzt sich der "Bunte Wind" f√ºr eine offene Gesellschaft ein. Das B√ºndnis organisiert Proteste gegen Rechts und f√∂rdert die Vernetzung von Demokraten im Bezirk.</p>`,
                        'source': 'Bunter Wind'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'licht_blicke', 'category': 'widerstand', 'title': 'LOCKED: Licht-Blicke', 'year': 2002, 'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/e/e5/Gudrunstra%C3%9Fe_Berlin-Lichtenberg.jpg', // Placeholder location
                        'description': `<h3>Netzwerk f√ºr Demokratie</h3><p>Licht-Blicke ist die zentrale Anlaufstelle f√ºr Demokratief√∂rderung in Lichtenberg. Sie koordinieren Stolperstein-Verlegungen und unterst√ºtzen Opfer rechter Gewalt.</p>`,
                        'source': 'Licht-Blicke'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5205, 52.4962] }
                },
                {
                    'type': 'Feature',
                    'properties': {
                        'id': 'berliner_register', 'category': 'heute', 'title': 'LOCKED: Berliner Register', 'year': 2005, 'locked': true,
                        'image': 'https://upload.wikimedia.org/wikipedia/commons/2/2e/Rathaus_Lichtenberg.jpg',
                        'description': `<h3>Dokumentation des Alltags</h3><p>Das Register dokumentiert rassistische und rechtsextreme Vorf√§lle im Alltag ‚Äì auch solche unterhalb der Strafbarkeitsgrenze. Dies macht das Ausma√ü der Diskriminierung sichtbar.</p>`,
                        'source': 'Berliner Register'
                    },
                    'geometry': { 'type': 'Point', 'coordinates': [13.5055, 52.5115] }
                }
            ]
        };

        // ------------------------------------------------------------------
        // 2. STATE & CONFIG
        // ------------------------------------------------------------------
        mapboxgl.accessToken = 'pk.eyJ1IjoiaWxpYXNtZXJhYmloYSIsImEiOiJjbWw5bHNnc3YwM3ZwM2RxdXU5YjdiN201In0.CTiUlh-M4fTkIda8EtP4Yg'; 

        let state = {
            discovered: [],
            required: 3,
            unlocked: false,
            scanner: null,
            lastScannedId: null
        };

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [13.485, 52.51],
            zoom: 12.5,
            pitch: 45,
            bearing: -10,
            maxBounds: [[13.3, 52.4], [13.7, 52.6]] 
        });

        // ------------------------------------------------------------------
        // 3. START APP SEQUENCE
        // ------------------------------------------------------------------
        function startApp() {
            // REMOVE OVERLAY FIRST (Force access)
            document.getElementById('start-screen').style.display = 'none';
            
            // Try to enable audio context (for beeps)
            try {
                new (window.AudioContext || window.webkitAudioContext)().resume();
            } catch(e) {}

            // Init Scanner quietly
            initScanner();
        }

        function initScanner() {
            try {
                if(!state.scanner) state.scanner = new Html5Qrcode("reader");
                state.scanner.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: 80 }, 
                    onScanSuccess
                ).catch(err => console.log("Camera failed to start (silent)", err));
            } catch(e) {
                console.log("Scanner library error", e);
            }
        }

        function onScanSuccess(decodedText) {
            let foundId = null;
            for(let f of geoData.features) {
                if(decodedText.includes(f.properties.id)) {
                    foundId = f.properties.id;
                    break;
                }
            }

            if(foundId && foundId !== state.lastScannedId) {
                state.lastScannedId = foundId;
                state.scanner.pause();
                
                const overlay = document.getElementById('scan-hit-overlay');
                overlay.style.display = 'flex';
                document.getElementById('mini-scanner').style.borderColor = "#00E676";
            }
        }

        function executeScanAction() {
            const id = state.lastScannedId;
            const feature = geoData.features.find(f => f.properties.id === id);
            
            if(feature) {
                if (!state.discovered.includes(id)) {
                    state.discovered.push(id);
                    updateProgress();
                }
                
                if (feature.properties.locked) {
                    unlockAll();
                } else {
                    document.getElementById('year-slider').value = feature.properties.year;
                    document.getElementById('year-display').innerText = feature.properties.year;
                    updateMap(feature.properties.year);
                }
                handleMarker(feature.properties, feature.geometry.coordinates);
            }

            setTimeout(() => {
                document.getElementById('scan-hit-overlay').style.display = 'none';
                document.getElementById('mini-scanner').style.borderColor = "#444";
                state.lastScannedId = null;
                state.scanner.resume();
            }, 1000);
        }

        // ------------------------------------------------------------------
        // 4. MAP LOGIC
        // ------------------------------------------------------------------
        map.on('load', () => {
            // 3D Buildings
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field']).id;
            map.addLayer({ 'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'filter': ['==', 'extrude', 'true'], 'type': 'fill-extrusion', 'paint': { 'fill-extrusion-color': '#222', 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-opacity': 0.9 } }, labelLayerId);

            // Markers Source
            map.addSource('markers', { 'type': 'geojson', 'data': geoData });
            
            // GLOW EFFECT (Stronger)
            map.addLayer({ 'id': 'marker-glow', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 60, 'circle-color': ['match', ['get', 'category'], 'erinnerung', '#D4AF37', 'gedenken', '#A0A0A0', 'widerstand', '#00E676', 'heute', '#FF3D00', '#fff'], 'circle-opacity': 0.6, 'circle-blur': 0.8 } });
            
            // CORE DOT
            map.addLayer({ 'id': 'marker-core', 'type': 'circle', 'source': 'markers', 'paint': { 'circle-radius': 8, 'circle-color': '#fff', 'circle-stroke-width': 2, 'circle-stroke-color': '#000' } });

            map.on('click', 'marker-core', (e) => handleMarker(e.features[0].properties, e.features[0].geometry.coordinates));
            map.on('mouseenter', 'marker-core', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'marker-core', () => map.getCanvas().style.cursor = '');

            // Deep Link Handler
            const urlParams = new URLSearchParams(window.location.search);
            const startEvent = urlParams.get('event');
            if(startEvent) {
                document.getElementById('start-screen').style.display = 'none';
                const t = geoData.features.find(f => f.properties.id === startEvent);
                if(t) handleMarker(t.properties, t.geometry.coordinates);
            }

            updateMap(1933);
        });

        function handleMarker(props, coords) {
            if (props.locked && !state.unlocked) { openSidebarLocked(); return; }
            if (!state.discovered.includes(props.id) && !props.locked) { state.discovered.push(props.id); updateProgress(); }
            map.flyTo({ center: coords, zoom: 16, pitch: 60, offset: [0, -200], speed: 0.8 });
            openSidebar(props);
        }

        function updateProgress() {
            const pct = Math.min((state.discovered.length / state.required) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            if (state.discovered.length >= state.required && !state.unlocked) {
                setTimeout(unlockAll, 1000);
            }
        }

        function unlockAll() {
            state.unlocked = true;
            document.getElementById('lock-status').innerText = "ARCHIV ENTSCHL√úSSELT";
            document.getElementById('lock-status').style.color = "#00E676";
            document.getElementById('progress-bar').style.background = "#00E676";
            document.getElementById('year-slider').value = 2026;
            document.getElementById('year-display').innerText = 2026;
            updateMap(2026);
        }

        const slider = document.getElementById('year-slider');
        slider.addEventListener('input', (e) => {
            const year = parseInt(e.target.value);
            document.getElementById('year-display').innerText = year;
            updateMap(year);
        });

        function updateMap(year) {
            const filter = ['<=', ['get', 'year'], year];
            map.setFilter('marker-glow', filter);
            map.setFilter('marker-core', filter);
        }

        function openSidebar(data) {
            const content = document.getElementById('sidebar-content');
            const colors = { 'erinnerung': '#D4AF37', 'gedenken': '#A0A0A0', 'widerstand': '#00E676', 'heute': '#FF3D00' };
            content.innerHTML = `<img src="${data.image}" class="hero-img"><div class="sidebar-content"><span class="cat-tag" style="border-color:${colors[data.category]}; color:${colors[data.category]}">${data.category.toUpperCase()}</span><h2>${data.title}</h2><div class="article">${data.description}</div><div class="source">Quelle: ${data.source} ‚Ä¢ Jahr: ${data.year}</div></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function openSidebarLocked() {
            document.getElementById('sidebar-content').innerHTML = `<div class="locked-view"><div class="locked-icon">üîí</div><h2 style="color:#FF3D00">DATEN VERSCHL√úSSELT</h2><p>Erforschen Sie erst die Geschichte.</p></div>`;
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            map.easeTo({ offset: [0, 0] });
        }
    </script>
</body>
</html>
